From 006f265a940254fbefe16238b803b7030699e799 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Mon, 27 Oct 2025 15:37:17 +0100
Subject: [PATCH 01/10] look for libraries in PREFIX first

also add target-based include paths for CUDA compilers
---
 tinygrad/runtime/autogen/__init__.py      | 30 ++++++++++++++---------
 tinygrad/runtime/autogen/libclang.py      |  3 ++-
 tinygrad/runtime/autogen/llvm.py          |  4 +--
 tinygrad/runtime/autogen/nvjitlink.py     |  4 +--
 tinygrad/runtime/autogen/nvrtc.py         |  4 +--
 tinygrad/runtime/support/c.py             | 20 ++++++++++++++-
 tinygrad/runtime/support/compiler_cuda.py |  3 ++-
 7 files changed, 47 insertions(+), 21 deletions(-)

diff --git a/tinygrad/runtime/autogen/__init__.py b/tinygrad/runtime/autogen/__init__.py
index 5617e73f6..e376db56d 100644
--- a/tinygrad/runtime/autogen/__init__.py
+++ b/tinygrad/runtime/autogen/__init__.py
@@ -1,5 +1,6 @@
 import glob, importlib, pathlib, subprocess, tarfile
-from tinygrad.helpers import fetch, flatten, system, getenv
+from tinygrad.helpers import fetch, flatten, system, getenv, WIN
+from tinygrad.runtime.support.c import CONDA_PREFIX, CUDA_TARGET_DIR
 
 root = (here:=pathlib.Path(__file__).parent).parents[2]
 nv_src = {"nv_570": "https://github.com/NVIDIA/open-gpu-kernel-modules/archive/81fe4fb417c8ac3b9bdcc1d56827d116743892a5.tar.gz",
@@ -8,8 +9,12 @@ ffmpeg_src = "https://ffmpeg.org/releases/ffmpeg-8.0.1.tar.gz"
 rocr_src = "https://github.com/ROCm/rocm-systems/archive/refs/tags/rocm-7.1.1.tar.gz"
 macossdk = "/var/db/xcode_select_link/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
 
-llvm_lib = (r"'C:\\Program Files\\LLVM\\bin\\LLVM-C.dll' if WIN else '/opt/homebrew/opt/llvm@20/lib/libLLVM.dylib' if OSX else " +
-            repr(['LLVM'] + [f'LLVM-{i}' for i in reversed(range(14, 21+1))]))
+llvm_name = "'LLVM-C' if WIN else 'LLVM'"
+clang_name = "'libclang-13' if WIN else 'clang'"
+
+CUDA_INCLUDE = CONDA_PREFIX/"include" if WIN else CONDA_PREFIX/CUDA_TARGET_DIR/"include"
+nvrtc_path = "'nvrtc64_@CUDA_VERSION@_0' if WIN else 'nvrtc'"
+nvjitlink_path = "'nvJitLink_@CUDA_VERSION@_0' if WIN else 'nvJitLink'"
 
 webgpu_lib = "os.path.join(sysconfig.get_paths()['purelib'], 'pydawn', 'lib', 'libwebgpu_dawn.dll') if WIN else 'webgpu_dawn'"
 nv_lib_path = "f'/usr/local/cuda/targets/{sysconfig.get_config_vars().get(\"MULTIARCH\", \"\").rsplit(\"-\", 1)[0]}/lib'"
@@ -36,10 +41,10 @@ def __getattr__(nm):
       [i for i in system("dpkg -L libc6-dev").split() if 'sys/mman.h' in i or 'sys/syscall.h' in i] +
       ["/usr/include/string.h", "/usr/include/elf.h", "/usr/include/unistd.h", "/usr/include/asm-generic/mman-common.h"]), errno=True)
     case "avcodec": return load("avcodec", None, ["{}/libavcodec/hevc/hevc.h", "{}/libavcodec/cbs_h265.h"], tarball=ffmpeg_src)
-    case "opencl": return load("opencl", "'OpenCL'", ["/usr/include/CL/cl.h"])
-    case "cuda": return load("cuda", "'cuda'", ["/usr/include/cuda.h"], args=["-D__CUDA_API_VERSION_INTERNAL"], parse_macros=False)
-    case "nvrtc": return load("nvrtc", "'nvrtc'", ["/usr/include/nvrtc.h"], paths=nv_lib_path, prolog=["import sysconfig"])
-    case "nvjitlink": load("nvjitlink", "'nvJitLink'", [root/"extra/nvJitLink.h"], paths=nv_lib_path, prolog=["import sysconfig"])
+    case "opencl": return load("opencl", "'OpenCL'", [CUDA_INCLUDE/"CL/cl.h"])
+    case "cuda": return load("cuda", "'cuda'", [CUDA_INCLUDE/"cuda.h"], args=["-D__CUDA_API_VERSION_INTERNAL"], parse_macros=False)
+    case "nvrtc": return load("nvrtc", nvrtc_path, [CUDA_INCLUDE/"nvrtc.h"], prolog=["from tinygrad.helpers import WIN"])
+    case "nvjitlink": load("nvjitlink", nvjitlink_path, [CUDA_INCLUDE/"nvJitLink.h"], prolog=["from tinygrad.helpers import WIN"])
     case "kfd": return load("kfd", None, [root/"extra/hip_gpu_driver/kfd_ioctl.h"])
     case "nv_570" | "nv_580":
       return load(nm, None, [
@@ -79,8 +84,9 @@ def __getattr__(nm):
                                  rules=[('__NR', 'NR')])
     case "ib": return load("ib", "'ibverbs'", ["/usr/include/infiniband/verbs.h", "/usr/include/infiniband/verbs_api.h",
                                                "/usr/include/infiniband/ib_user_ioctl_verbs.h","/usr/include/rdma/ib_user_verbs.h"], errno=True)
-    case "llvm": return load("llvm", llvm_lib, lambda: [system("llvm-config-20 --includedir")+"/llvm-c/**/*.h"],
-                             args=lambda: system("llvm-config-20 --cflags").split(), recsym=True, prolog=["from tinygrad.helpers import WIN, OSX"])
+    case "llvm":
+      return load("llvm", llvm_name, CONDA_PREFIX/"include"/"llvm-c/**/*.h",
+                  args=lambda: system("llvm-config --cflags").split(), recsym=True, prolog=["from tinygrad.helpers import WIN"])
     case "pci": return load("pci", None, ["/usr/include/linux/pci_regs.h"])
     case "vfio": return load("vfio", None, ["/usr/include/linux/vfio.h"])
     # could add rule: WGPU_COMMA -> ','
@@ -134,9 +140,9 @@ def __getattr__(nm):
   tarball="https://gitlab.freedesktop.org/mesa/mesa/-/archive/mesa-25.2.7/mesa-25.2.7.tar.gz",
   prolog=["import gzip, base64"], epilog=lambda path: [system(f"{root}/extra/mesa/lvp_nir_options.sh {path}")])
     case "libclang":
-      return load("libclang", "['clang-20', 'clang']",
-                  lambda: [f"{system('llvm-config-20 --includedir')}/clang-c/{s}.h" for s in ["Index", "CXString", "CXSourceLocation", "CXFile"]],
-                  args=lambda: system("llvm-config-20 --cflags").split())
+      return load("libclang", clang_name,
+                  [CONDA_PREFIX/"include"/"clang-c"/f"{s}.h" for s in ["Index", "CXString", "CXSourceLocation", "CXFile"]],
+                  args=lambda: system("llvm-config --cflags").split(), prolog=["from tinygrad.helpers import WIN"])
     case "metal":
       return load("metal", "'Metal'", [f"{macossdk}/System/Library/Frameworks/Metal.framework/Headers/MTL{s}.h" for s in
                   ["ComputeCommandEncoder", "ComputePipeline", "CommandQueue", "Device", "IndirectCommandBuffer", "Resource", "CommandEncoder"]],
diff --git a/tinygrad/runtime/autogen/libclang.py b/tinygrad/runtime/autogen/libclang.py
index dbf22b6f5..40efbd00f 100644
--- a/tinygrad/runtime/autogen/libclang.py
+++ b/tinygrad/runtime/autogen/libclang.py
@@ -1,7 +1,8 @@
 # mypy: ignore-errors
 import ctypes
 from tinygrad.runtime.support.c import DLL, Struct, CEnum, _IO, _IOW, _IOR, _IOWR
-dll = DLL('libclang', ['clang-20', 'clang'])
+from tinygrad.helpers import WIN
+dll = DLL('libclang', 'libclang-13' if WIN else 'clang')
 CXIndex = ctypes.c_void_p
 class struct_CXTargetInfoImpl(Struct): pass
 CXTargetInfo = ctypes.POINTER(struct_CXTargetInfoImpl)
diff --git a/tinygrad/runtime/autogen/llvm.py b/tinygrad/runtime/autogen/llvm.py
index 7d05224e7..98a2b7121 100644
--- a/tinygrad/runtime/autogen/llvm.py
+++ b/tinygrad/runtime/autogen/llvm.py
@@ -1,8 +1,8 @@
 # mypy: ignore-errors
 import ctypes
 from tinygrad.runtime.support.c import DLL, Struct, CEnum, _IO, _IOW, _IOR, _IOWR
-from tinygrad.helpers import WIN, OSX
-dll = DLL('llvm', 'C:\\Program Files\\LLVM\\bin\\LLVM-C.dll' if WIN else '/opt/homebrew/opt/llvm@20/lib/libLLVM.dylib' if OSX else ['LLVM', 'LLVM-21', 'LLVM-20', 'LLVM-19', 'LLVM-18', 'LLVM-17', 'LLVM-16', 'LLVM-15', 'LLVM-14'])
+from tinygrad.helpers import WIN
+dll = DLL('llvm', 'LLVM-C' if WIN else 'LLVM')
 intmax_t = ctypes.c_int64
 try: (imaxabs:=dll.imaxabs).restype, imaxabs.argtypes = intmax_t, [intmax_t]
 except AttributeError: pass
diff --git a/tinygrad/runtime/autogen/nvjitlink.py b/tinygrad/runtime/autogen/nvjitlink.py
index 29f3d3f2d..863695801 100644
--- a/tinygrad/runtime/autogen/nvjitlink.py
+++ b/tinygrad/runtime/autogen/nvjitlink.py
@@ -1,8 +1,8 @@
 # mypy: ignore-errors
 import ctypes
 from tinygrad.runtime.support.c import DLL, Struct, CEnum, _IO, _IOW, _IOR, _IOWR
-import sysconfig
-dll = DLL('nvjitlink', 'nvJitLink', f'/usr/local/cuda/targets/{sysconfig.get_config_vars().get("MULTIARCH", "").rsplit("-", 1)[0]}/lib')
+from tinygrad.helpers import WIN
+dll = DLL('nvjitlink', 'nvJitLink_@CUDA_VERSION@_0' if WIN else 'nvJitLink')
 nvJitLinkResult = CEnum(ctypes.c_uint32)
 NVJITLINK_SUCCESS = nvJitLinkResult.define('NVJITLINK_SUCCESS', 0)
 NVJITLINK_ERROR_UNRECOGNIZED_OPTION = nvJitLinkResult.define('NVJITLINK_ERROR_UNRECOGNIZED_OPTION', 1)
diff --git a/tinygrad/runtime/autogen/nvrtc.py b/tinygrad/runtime/autogen/nvrtc.py
index 88085c45b..57f437d7d 100644
--- a/tinygrad/runtime/autogen/nvrtc.py
+++ b/tinygrad/runtime/autogen/nvrtc.py
@@ -1,8 +1,8 @@
 # mypy: ignore-errors
 import ctypes
 from tinygrad.runtime.support.c import DLL, Struct, CEnum, _IO, _IOW, _IOR, _IOWR
-import sysconfig
-dll = DLL('nvrtc', 'nvrtc', f'/usr/local/cuda/targets/{sysconfig.get_config_vars().get("MULTIARCH", "").rsplit("-", 1)[0]}/lib')
+from tinygrad.helpers import WIN
+dll = DLL('nvrtc', 'nvrtc64_@CUDA_VERSION@_0' if WIN else 'nvrtc')
 nvrtcResult = CEnum(ctypes.c_uint32)
 NVRTC_SUCCESS = nvrtcResult.define('NVRTC_SUCCESS', 0)
 NVRTC_ERROR_OUT_OF_MEMORY = nvrtcResult.define('NVRTC_ERROR_OUT_OF_MEMORY', 1)
diff --git a/tinygrad/runtime/support/c.py b/tinygrad/runtime/support/c.py
index f6e543043..9a68b10b6 100644
--- a/tinygrad/runtime/support/c.py
+++ b/tinygrad/runtime/support/c.py
@@ -37,13 +37,31 @@ def CEnum(typ: type[ctypes._SimpleCData]):
 
   return _CEnum
 
+CONDA_PREFIX = getenv("CONDA_PREFIX", "")
+# if present, turn into full path; windows has a different layout
+CONDA_PREFIX = pathlib.Path(CONDA_PREFIX)/"Library" if WIN else pathlib.Path(CONDA_PREFIX)
+
+import sys, platform
+match (sys.platform, platform.machine().lower()):
+    case ("linux", "x86_64"):
+        CUDA_TARGET_DIR = "targets/x86_64-linux"
+    case ("linux", m) if m in ("aarch64", "arm64"):
+        CUDA_TARGET_DIR = "targets/sbsa-linux"
+    case ("win32", "amd64"):
+        CUDA_TARGET_DIR = "x64"
+    case ("darwin", _):
+        CUDA_TARGET_DIR = ""
+    case (s, m):
+        raise ValueError(f"unknown platform: sys.platform={s}, platform.machine()={m}")
+
 class DLL(ctypes.CDLL):
   @staticmethod
   def findlib(nm:str, paths:list[str], extra_paths=[]):
     if nm == 'libc' and OSX: return '/usr/lib/libc.dylib'
     if pathlib.Path(path:=getenv(nm.replace('-', '_').upper()+"_PATH", '')).is_file(): return path
     for p in paths:
-      libpaths = {"posix": ["/usr/lib64", "/usr/lib", "/usr/local/lib"], "nt": os.environ['PATH'].split(os.pathsep),
+      libpaths = {"posix": [CONDA_PREFIX/"lib", CONDA_PREFIX/CUDA_TARGET_DIR/"lib", "/usr/lib64", "/usr/lib", "/usr/local/lib"],
+                  "nt": [CONDA_PREFIX/"bin"] + os.environ['PATH'].split(os.pathsep),
                   "darwin": ["/opt/homebrew/lib", f"/System/Library/Frameworks/{p}.framework"],
                   'linux': ['/lib', '/lib64', f"/lib/{sysconfig.get_config_var('MULTIARCH')}", "/usr/lib/wsl/lib/"]}
       if (pth:=pathlib.Path(p)).is_absolute():
diff --git a/tinygrad/runtime/support/compiler_cuda.py b/tinygrad/runtime/support/compiler_cuda.py
index 8f71a9255..7ec0838a1 100644
--- a/tinygrad/runtime/support/compiler_cuda.py
+++ b/tinygrad/runtime/support/compiler_cuda.py
@@ -2,6 +2,7 @@ import subprocess, hashlib, tempfile, ctypes, re, pathlib
 from typing import Callable
 from tinygrad.helpers import to_char_p_p, colored, init_c_var, getenv, system
 from tinygrad.runtime.autogen import nvrtc, nvjitlink as jitlink
+from tinygrad.runtime.support.c import CONDA_PREFIX, CUDA_TARGET_DIR
 from tinygrad.device import Compiler, CompileError
 
 CUDA_PATH = getenv("CUDA_PATH", "")
@@ -43,7 +44,7 @@ def cuda_disassemble(lib:bytes, arch:str):
 class CUDACompiler(Compiler):
   def __init__(self, arch:str, cache_key:str="cuda"):
     self.arch, self.compile_options = arch, [f'--gpu-architecture={arch}']
-    self.compile_options += [f"-I{CUDA_PATH}/include"] if CUDA_PATH else ["-I/usr/local/cuda/include", "-I/usr/include", "-I/opt/cuda/include"]
+    self.compile_options += [f"-I{CONDA_PREFIX}/include"] + (not WIN) * [f"-I{CONDA_PREFIX}/{CUDA_TARGET_DIR}/include"]
     nvrtc_check(nvrtc.nvrtcVersion((nvrtcMajor := ctypes.c_int()), (nvrtcMinor := ctypes.c_int())))
     if (nvrtcMajor.value, nvrtcMinor.value) >= (12, 4): self.compile_options.append("--minimal")
     super().__init__(f"compile_{cache_key}_{self.arch}")
